

<ul class="list-group">
{% if notificaciones %}
    {% for n in notificaciones %}
        <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap notificacion-item">
            <div class="me-3">
                <strong>{{ n.mensaje }}</strong><br>
                <small class="text-muted">
                    {% if n.fecha is string %}
                        {{ n.fecha }}
                    {% else %}
                        {{ n.fecha.strftime("%d/%m/%Y %H:%M") }}
                    {% endif %}
                </small>
            </div>

            <div class="btn-group">
                {# NOTIFICACIONES DE SOLICITUDES PARA EL ADMIN #}
                {% if n.tipo == 'solicitud' %}
                    {% if session.usuario.id == n.creador_id %}
                        <a href="{{ url_for('perfil', id=n.solicitante_id) }}" class="btn btn-info btn-sm">
                            Ver perfil
                        </a>
                        <button class="btn btn-success btn-sm btn-aceptar"
                                data-solicitud="{{ n.solicitud_id }}"
                                data-usuario="{{ n.solicitante_id }}"
                                data-url="{{ url_for('aceptar_solicitud_modal', id=n.solicitud_id, usuario_id=n.solicitante_id) }}">
                            Aceptar
                        </button>
                        <button class="btn btn-danger btn-sm btn-rechazar"
                                data-solicitud="{{ n.solicitud_id }}"
                                data-usuario="{{ n.solicitante_id }}"
                                data-url="{{ url_for('rechazar_solicitud_admin', id=n.solicitud_id, usuario_id=n.solicitante_id) }}">
                            Rechazar
                        </button>
                    {% endif %}

                {# NOTIFICACIONES DE SOLICITUDES PARA EL USUARIO QUE ENVIÓ #}
                {% elif n.tipo == 'solicitud_usuario' or (n.tipo == 'solicitud' and session.usuario.id == n.solicitante_id) %}
                    {% if n.solicitud_estado == 'pendiente' %}
                        <span class="badge bg-warning">Pendiente</span>
                    {% elif n.solicitud_estado == 'aceptada' %}
                        <span class="badge bg-success">Aceptada</span>
                    {% elif n.solicitud_estado == 'rechazada' %}
                        <span class="badge bg-danger">Rechazada</span>
                    {% else %}
                        <span class="badge bg-secondary">{{ n.solicitud_estado }}</span>
                    {% endif %}

                {# NOTIFICACIONES DE RESPUESTA #}
                {% elif n.tipo == 'respuesta' %}
                    {% if 'aceptada' in n.mensaje.lower() %}
                        <span class="badge bg-success">Aceptada</span>
                    {% elif 'rechazada' in n.mensaje.lower() %}
                        <span class="badge bg-danger">Rechazada</span>
                    {% else %}
                        <span class="badge bg-success">Aceptada</span>
                    {% endif %}
                {% endif %}
            </div>
        </li>
    {% endfor %}
{% else %}
    <li class="list-group-item text-center text-muted">No hay notificaciones.</li>
{% endif %}
</ul>


<script>
document.addEventListener('click', async (e) => {
    if (e.target.classList.contains('btn-aceptar') || e.target.classList.contains('btn-rechazar')) {
        const btn = e.target;
        const solicitudId = btn.dataset.solicitud;
        if (!solicitudId) {
            console.error('Falta data-solicitud en el botón');
            return;
        }

        const nuevoEstado = btn.classList.contains('btn-aceptar') ? 'aceptada' : 'rechazada';
        const color = nuevoEstado === 'aceptada' ? 'bg-success' : 'bg-danger';
        const emoji = nuevoEstado === 'aceptada' ? '✅' : '❌';
        const texto = nuevoEstado === 'aceptada' ? 'Solicitud aceptada' : 'Solicitud rechazada';

        try {
            btn.disabled = true;
            const resp = await fetch('/notificaciones/actualizar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ solicitud_id: solicitudId, estado: nuevoEstado })
            });

            const data = await resp.json().catch(() => null);

            if (resp.ok && data && data.success) {
                const li = btn.closest('li');

                // animación de salida
                li.style.transition = 'all 0.4s ease';
                li.style.opacity = '0';
                li.style.transform = 'scale(0.95)';

                setTimeout(() => {
                    li.innerHTML = `
                        <div class="me-3 fade-in">
                            <strong>${texto} ${emoji}</strong><br>
                            <small class="text-muted">Actualizado correctamente</small>
                        </div>
                        <span class="badge ${color}">
                            ${nuevoEstado.charAt(0).toUpperCase() + nuevoEstado.slice(1)}
                        </span>
                    `;

                    // animación de entrada
                    li.style.opacity = '1';
                    li.style.transform = 'scale(1)';
                }, 400);
            } else {
                const msg = (data && data.message) ? data.message : 'Error al actualizar la solicitud';
                alert(msg);
                btn.disabled = false;
            }
        } catch (err) {
            console.error(err);
            alert('Error en la petición (ver consola)');
            btn.disabled = false;
        }
    }
});
</script>

<style>
/* Suaviza las animaciones */
.fade-in {
    animation: fadeIn 0.5s ease forwards;
}
@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
}
</style>




